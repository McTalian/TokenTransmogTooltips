---
name: 'generate-token'
description: 'Generate Lua/XML code from the PLAN OUTPUT section of a raid token record'
agent: agent
argument-hint: 'ID (3-digit record number, e.g. 001)'
---
# Generate Raid Code

Generate the complete Lua and XML code for a new raid based on the PLAN OUTPUT section of a raid token record.

## Parameters

- `ID`: The 3-digit identifier corresponding to the raid token record markdown file (e.g., "001")

## Prerequisites

The raid record file must contain:
- A complete and valid PLAN OUTPUT section (generated by `/plan-token`)
- Token Groups & Class Mappings
- Token ID Mappings
- Class/Difficulty/Slot appearance data

## Process

### 1. Validate ID and PLAN OUTPUT

1. Check that `ID` matches an existing file in `/.github/raid_token_records/`
2. Verify the file contains a complete PLAN OUTPUT section
3. If missing or invalid, instruct user to run `/plan-token ID="{ID}"` first

### 2. Parse PLAN OUTPUT

Extract from the PLAN OUTPUT section:
- Raid name (from filename and metadata)
- Token group definitions and class mappings
- Token ID → Difficulty → TokenGroup → Slot mappings
- Class/Difficulty/Slot → AppearanceID → ModID data

### 3. Generate Directory Structure

Create the following directory structure:
```
TokenTransmogTooltips/Raids/{RaidName}/
  {tokengroup1}/
  {tokengroup2}/
  ...
```

### 4. Generate Class Files

For each token group and each class in that group, create:

**Path**: `TokenTransmogTooltips/Raids/{RaidName}/{tokengroup}/{class}.lua`

**Structure**:
```lua
local addonName, ns = ...
local mergeTable = ns.mergeTable

ns._Gear.{RaidName}.{CLASS} = {
  ["{DIFFICULTY}"] = {
    ["{SLOT}"] = {
      [{appearanceID}] = { {modID}, },
    },
    -- ... other slots
  },
  -- ... other difficulties
}

-- If curio/wildcard tokens exist, merge all slots into ["ALL"]
ns._Gear.{RaidName}.{CLASS}["{DIFFICULTY}"]["ALL"] = mergeTable(
  ns._Gear.{RaidName}.{CLASS}["{DIFFICULTY}"]["HELM"],
  ns._Gear.{RaidName}.{CLASS}["{DIFFICULTY}"]["SHOULDERS"],
  -- ... all slots
)
```

**Key Requirements**:
- Use difficulty names from PLAN OUTPUT (e.g., "RAID_FINDER", "NORMAL", "HEROIC", "MYTHIC")
- Single-element arrays must use trailing comma: `{ modID, }`
- Include ALL slot if curio tokens exist
- Follow project standards for indentation and formatting

### 5. Generate Token Group Aggregators

For each token group, create:

**Path**: `TokenTransmogTooltips/Raids/{RaidName}/{tokengroup}/{tokengroup}.lua`

**Structure**:
```lua
local addonName, ns = ...
local gear = ns._Gear.{RaidName}

ns._Gear.{RaidName}.{TOKENGROUP} = {
  ["{DIFFICULTY}"] = {
    ["{SLOT}"] = {
      ["{CLASS1}"] = gear.{CLASS1}["{DIFFICULTY}"]["{SLOT}"],
      ["{CLASS2}"] = gear.{CLASS2}["{DIFFICULTY}"]["{SLOT}"],
      -- ... all classes in this token group
    },
    -- ... other slots
  },
  -- ... other difficulties
}
```

**Key Requirements**:
- Reference all classes in the token group
- Cover all difficulties
- Cover all slots (including ALL if applicable)
- Use local `gear` variable for brevity

### 6. Generate Token Group _index.xml

For each token group, create:

**Path**: `TokenTransmogTooltips/Raids/{RaidName}/{tokengroup}/_index.xml`

**Structure**:
```xml
<Ui xmlns="http://www.blizzard.com/wow/ui/">
  <!-- Class files first (order doesn't matter) -->
  <Script file="{class1}.lua"/>
  <Script file="{class2}.lua"/>
  <!-- ... all classes -->
  <!-- Aggregator last -->
  <Script file="{tokengroup}.lua"/>
</Ui>
```

**Load Order**: Classes before aggregator

### 7. Generate Raid _index.lua

**Path**: `TokenTransmogTooltips/Raids/{RaidName}/_index.lua`

**Structure**:
```lua
local addonName, ns = ...

ns._Gear.{RaidName} = {}
```

### 8. Generate tokens.lua

**Path**: `TokenTransmogTooltips/Raids/{RaidName}/tokens.lua`

**Structure**:
```lua
local addonName, ns = ...
local {tokengroup1} = ns._Gear.{RaidName}.{TOKENGROUP1}
local {tokengroup2} = ns._Gear.{RaidName}.{TOKENGROUP2}
-- ... all token groups

ns.Raids.{RaidName} = {
  [{tokenID}] = {
    Difficulties = {
      [Enum.ItemCreationContext.RaidFinder] = {tokengroup}["{DIFFICULTY}"]["{SLOT}"],
      [Enum.ItemCreationContext.RaidNormal] = {tokengroup}["{DIFFICULTY}"]["{SLOT}"],
      [Enum.ItemCreationContext.RaidHeroic] = {tokengroup}["{DIFFICULTY}"]["{SLOT}"],
      [Enum.ItemCreationContext.RaidMythic] = {tokengroup}["{DIFFICULTY}"]["{SLOT}"],
    },
  },
  -- ... other tokens
}
```

**Key Requirements**:
- Use `Enum.ItemCreationContext.*` constants (NOT numeric values)
- Map each token ID to correct token group, difficulty, and slot
- Handle faction-specific tokens if noted in PLAN OUTPUT
- Local variables for token groups

### 9. Generate Raid _index.xml

**Path**: `TokenTransmogTooltips/Raids/{RaidName}/_index.xml`

**Structure**:
```xml
<Ui xmlns="http://www.blizzard.com/wow/ui/">
  <!-- Namespace creation first -->
  <Script file="_index.lua"/>
  <!-- Token groups (order doesn't matter) -->
  <Include file="{tokengroup1}/_index.xml"/>
  <Include file="{tokengroup2}/_index.xml"/>
  <!-- ... all token groups -->
  <!-- Token mapping last -->
  <Script file="tokens.lua"/>
</Ui>
```

**Load Order**: `_index.lua` → token groups → `tokens.lua`

### 10. Update _raids.xml

**Path**: `TokenTransmogTooltips/Raids/_raids.xml`

Add the new raid include in the appropriate location:
- Legacy raids: Alphabetical order
- Modern raids (Shadowlands+): Chronological order

```xml
<Include file="{RaidName}/_index.xml"/>
```

### 11. Verification

After code generation:
1. Confirm all files were created successfully
2. Check that load order is correct in all XML files
3. Verify difficulty enum usage (no numeric literals)
4. Validate single-element array syntax (trailing commas)
5. Check for any missing data or structural issues

### 12. Provide Testing Instructions

Instruct the user to:
1. Run `make build` to build the addon
2. Load into WoW (alpha build recommended for debug features)
3. Test token tooltips for each difficulty
4. Verify class icons, missing/collected status, and data accuracy
5. Refer to [.github/docs/testing-guide.md](../docs/testing-guide.md) for comprehensive checklist

## Error Handling

If any required data is missing or ambiguous:
1. **HALT IMMEDIATELY**
2. List specific issues preventing code generation
3. Reference the section/data needed
4. Instruct user to update raid record and re-run planning if needed

## Example Usage

```
/generate-token ID="002"
```

## Output

- Creates: All Lua and XML files for the new raid
- Updates: `TokenTransmogTooltips/Raids/_raids.xml`
- User receives: File creation summary and testing instructions

## Code Quality Standards

Generated code must adhere to:
- [.github/instructions/standards.instructions.md](../instructions/standards.instructions.md) - Coding conventions
- [.github/instructions/data-model.instructions.md](../instructions/data-model.instructions.md) - Data structure patterns

Key points:
- Forward slashes in file paths
- Trailing commas in all tables
- No semicolons
- 2-space indentation
- Comments explaining non-obvious logic
- Local variables for frequently referenced data
